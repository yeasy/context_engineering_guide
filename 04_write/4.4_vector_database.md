## 4.4 向量数据库实践

### 向量数据库概述

**向量数据库**是专门优化用于存储和检索高维向量的数据库系统。在上下文工程中，向量数据库是实现语义检索的核心基础设施。

工作原理：
1. 将文本通过嵌入模型转换为向量
2. 将向量存储到向量数据库
3. 查询时，将查询文本也转换为向量
4. 在数据库中搜索最相似的向量
5. 返回对应的原始文本

### 主流向量数据库对比

| 产品 | 类型 | 特点 | 适用场景 |
|------|------|------|----------|
| Pinecone | 云服务 | 全托管、易用 | 快速启动、中小规模 |
| Weaviate | 开源/云 | 功能丰富、GraphQL | 复杂查询需求 |
| Milvus | 开源 | 高性能、可扩展 | 大规模部署 |
| Qdrant | 开源 | 轻量、Rust 实现 | 性能敏感场景 |
| Chroma | 开源 | 简单、嵌入式 | 原型开发、本地使用 |
| pgvector | 扩展 | PostgreSQL 扩展 | 已有 PG 基础设施 |

### 向量索引算法

向量搜索的核心是近似最近邻搜索（ANN），常用算法：

**HNSW**

Hierarchical Navigable Small World，目前最常用的算法。
- 优点：检索速度快、精度高
- 缺点：内存占用较大、构建时间长
- 参数：M（连接数）、efConstruction（构建质量）、efSearch（搜索质量）

**IVF**

Inverted File Index，基于聚类的方法。
- 优点：内存占用低、支持增量更新
- 缺点：精度相对较低
- 参数：nlist（聚类数）、nprobe（搜索聚类数）

**PQ**

Product Quantization，向量压缩方法。
- 优点：大幅降低存储需求
- 缺点：精度损失明显
- 常与 IVF 结合使用

### 向量数据库使用实践

#### 嵌入模型选择

嵌入模型决定语义搜索的质量：

| 模型 | 维度 | 特点 |
|------|------|------|
| OpenAI text-embedding-3-small | 1536 | 成本低、质量好 |
| OpenAI text-embedding-3-large | 3072 | 精度最高 |
| BGE-Large | 1024 | 开源、多语言 |
| BGE-M3 | 1024 | 多功能、支持混合检索 |
| sentence-transformers | 变化 | 开源、本地部署 |

选择考虑：
- 质量需求
- 成本预算
- 是否需要本地部署
- 语言支持

#### 文档分块策略

良好的分块策略直接影响检索效果：

```mermaid
graph LR
    A["原始文档"] --> B["分块处理"]
    B --> C["语义块"]
    C --> D["向量化"]
    D --> E["索引存储"]
```

分块要点：
- 语义完整性：尽量保持语义单元完整
- 大小适中：通常 200-1000 Token
- 适当重叠：防止信息断裂
- 保留元数据：来源、章节、时间等

#### 检索优化

提升检索效果的实用技术：

**混合检索**

结合向量搜索和关键词搜索：
```
最终得分 = α × 语义得分 + (1-α) × 关键词得分
```

**元数据过滤**

先按元数据过滤，再在子集中向量搜索：
- 按时间范围过滤
- 按类别过滤
- 按来源过滤

**重排序**

对初步检索结果进行二次排序：
- 使用专门的重排序模型
- 考虑更多上下文因素

### 实际部署考量

#### 性能优化

- **批量操作**：批量写入和批量查询
- **缓存策略**：缓存热点查询结果
- **索引预热**：提前加载索引到内存

#### 扩展性

- **分片策略**：数据量大时的分片方案
- **副本配置**：高可用和读扩展
- **容量规划**：预估存储和计算需求

#### 成本控制

- **向量维度**：较小的维度降低存储和计算成本
- **压缩技术**：使用量化减少存储
- **冷热分离**：不常用数据使用低成本存储

### 常见问题处理

**检索结果不相关**
- 检查嵌入模型是否适合领域
- 优化分块策略
- 考虑添加重排序

**检索延迟过高**
- 优化索引参数
- 使用更高效的索引算法
- 考虑硬件升级

**更新导致不一致**
- 实现增量更新机制
- 设计合理的版本策略
- 定期重建索引
