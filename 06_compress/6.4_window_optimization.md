## 6.4 上下文窗口优化策略

### 6.4.1 上下文预算管理

像管理预算一样管理上下文容量，是优化的基础方法。

#### 预算分配

为不同组成部分预先分配 Token 预算：

| 组成部分 | 典型预算占比 | 说明 |
|----------|--------------|------|
| 系统提示词 | 5-15% | 尽量精简 |
| 知识/检索内容 | 30-50% | 核心信息区 |
| 对话历史 | 20-30% | 动态调整 |
| 输出预留 | 15-25% | 确保足够空间 |

#### 动态调整

根据任务特点动态调整分配：
- 知识密集任务：增加检索内容预算
- 多轮对话任务：增加历史预算
- 长文生成任务：增加输出预留

### 6.4.2 系统提示词优化

系统提示词是最稳定的上下文部分，应该优化到最精简。

#### 精简策略

**删除冗余**
- 移除重复说明
- 合并相似指令
- 使用简洁表达

**结构化表达**
- 使用列表替代段落
- 使用表格组织规则
- 采用编号便于引用

**模板复用**
- 将通用部分模板化
- 动态部分参数化
- 条件加载可选内容

#### 提示词压缩技术

**人工精简**

最直接有效，逐字审查每句话的必要性。

**LLM 辅助压缩**

让模型帮助精简：
```
请将以下系统提示词压缩到 500 Token 以内，保持所有关键指令：
[原始提示词]
```

**符号化表达**

用简洁符号替代冗长说明：
```
原文：如果用户没有明确指定格式，请使用 Markdown 格式输出
精简：默认格式=Markdown
```

### 6.4.3 检索内容优化

检索内容往往占用大量上下文，是优化重点。

#### 精准检索

- 提高检索精度，减少无关结果
- 使用重排序过滤低相关内容
- 根据置信度阈值截断结果

#### 检索后压缩

对检索结果进行二次压缩：
- 提取与查询相关的片段
- 生成针对性摘要
- 合并重复信息

#### 渐进式检索

按需检索，而非一次全部加载：
1. 先用少量关键信息回答
2. 如果需要更多细节再补充检索
3. 避免预防性的大量检索

### 6.4.4 格式优化

格式选择影响 Token 效率。

#### 结构化格式对比

| 格式 | Token 效率 | 可读性 | 适用场景 |
|------|------------|--------|----------|
| 纯文本 | 高 | 一般 | 连续内容 |
| Markdown | 中 | 好 | 结构化文档 |
| JSON | 低 | 中 | 数据交换 |
| XML | 最低 | 高 | 明确边界 |

#### 格式优化建议

- 非必要不使用嵌套结构
- 属性名尽量简短
- 避免冗长的 key 名称
- 考虑自定义简洁格式

### 6.4.5 缓存与复用

减少重复内容的传输和计算。

#### Prompt 缓存

许多模型支持 prompt 缓存：
- 相同的前缀只计算一次
- 后续请求复用缓存结果
- 节省计算成本和延迟

利用方式：
- 将稳定内容放在提示词前部
- 动态内容放在后部
- 保持前缀一致性

#### 预计算

对于频繁使用的内容预先计算：
- 预生成摘要并存储
- 检索结果预处理
- 通用模板预填充

### 6.4.6 监控与调优

#### 监控指标

- Token 使用分布：各部分占比
- 使用效率：有效信息/总 Token
- 边界情况：接近上限的频率
- 成本追踪：Token 费用趋势

#### 持续优化

1. 建立基准线
2. 识别最大消耗点
3. 针对性优化
4. 验证效果
5. 持续监控

上下文优化是一个持续的过程，需要在效果和效率之间找到最佳平衡点。
